<!DOCTYPE html>
<html>
<head>
    <title>Triton Flash & Configure</title>
    <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
    <style>
        body { font-family: sans-serif; padding: 2rem; }
        .hidden { display: none; }
        button { padding: 10px 20px; font-size: 16px; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Triton v8.4 Flasher</h1>

    <!-- Step 1: Flash Firmware -->
<div id="flash-section">
        <esp-web-install-button
            id="install-button"
            manifest="manifest.json"
        ></esp-web-install-button>
        <p>Status: <span id="install-state">-</span></p>
    </div>

    <button id="btn-force-show" style="margin-top: 40px; background: #f0f0f0; color: #666; font-size: 0.8em; border: 1px solid #ccc;">
        ⚠️ Manuelle Konfiguration öffnen (falls Popup fehlt)
    </button>

    <div id="config-section" class="hidden">
        <h2>Configuration</h2>
        <p>Firmware installed. Now configure the device.</p>

        <label>Tenant ID (Auto): <input type="text" id="tid" readonly></label><br><br>
        <label>Claim PIN (Auto): <input type="text" id="pin" readonly></label><br><br>
        <label>DB Secret: <input type="password" id="secret"></label><br><br>
        <label>Firebase Host: <input type="text" id="host"></label><br><br>
        <label>WiFi SSID: <input type="text" id="ssid"></label><br><br>
        <label>WiFi Password: <input type="password" id="pass"></label><br><br>

        <button id="btn-configure">Configure Device</button>
        <div id="config-status"></div>
        <h3>Debug Log:</h3>
        <pre id="debug-output" style="background: #f0f0f0; padding: 10px; max-height: 200px; overflow-y: auto;"></pre>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const installButton = document.getElementById('install-button');
        const configSection = document.getElementById('config-section');
        const sendConfigBtn = document.getElementById('btn-configure');
        const statusDiv = document.getElementById('config-status');
        const debugOutput = document.getElementById('debug-output');

        // IDs generieren
        window.onload = () => {
            document.getElementById('tid').value = "dev_" + Math.random().toString(36).substring(2, 8);
            document.getElementById('pin').value = Math.floor(100000 + Math.random() * 900000);
        };

        // Flash-Status anzeigen & Config freischalten
        installButton.addEventListener('state-change', (ev) => {
            const state = ev.detail.state;
            document.getElementById('install-state').innerText = state;

            console.log("Install Button State:", state);

            // WICHTIG: Wir reagieren nur auf den erfolgreichen FLASH-Vorgang.
            // Wir ignorieren Improv-Fehler des Tools, da wir unser eigenes nutzen.
            if (state === 'INSTALL_SUCCESSFUL' || state === 'OB_SUCCESS') {
                 configSection.classList.remove('hidden');
                 statusDiv.innerText = "Flash komplett. Bitte Gerät resetten und 'Configure Device' klicken.";
            }
        });

        // --- HAUPTFUNKTION: KONFIGURATION SENDEN ---
        sendConfigBtn.addEventListener('click', async () => {
            const secret = document.getElementById('secret').value;
            const host = document.getElementById('host').value;
            const ssid = document.getElementById('ssid').value;
            const pass = document.getElementById('pass').value;

            if (!secret || !host || !ssid || !pass) {
                statusDiv.innerText = "Error: Bitte alle Felder ausfüllen!";
                statusDiv.style.color = "red";
                return;
            }

            statusDiv.innerText = "Warte auf Gerät... Bitte auswählen.";
            statusDiv.style.color = "blue";
            debugOutput.textContent = "";

            let port;
            let reader;
            let writer;

            try {
                // 1. PORT ÖFFNEN
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200, dataTerminalReady: true, requestToSend: true });

                statusDiv.innerText = "Port offen. Warte auf 'READY' vom ESP32...";

                // 2. AUF "READY" WARTEN (Synchronisation)
                const textDecoder = new TextDecoderStream();
                const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
                reader = textDecoder.readable.getReader();

                let readyReceived = false;
                let buffer = "";

                // Lese Schleife bis READY kommt oder Timeout (5s)
                const timeout = setTimeout(() => {
                    if (!readyReceived) {
                        reader.cancel();
                        throw new Error("Timeout: Kein 'READY' vom ESP32 empfangen.");
                    }
                }, 5000);

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) {
                        buffer += value;
                        debugOutput.textContent += value; // Zeige an, was vom ESP kommt
                        if (buffer.includes("READY")) {
                            readyReceived = true;
                            clearTimeout(timeout);
                            break; // Raus aus der Leseschleife
                        }
                    }
                }

                reader.releaseLock(); // Reader freigeben für Writer

                if (!readyReceived) throw new Error("Verbindung geschlossen vor READY.");

                statusDiv.innerText = "ESP32 ist bereit! Sende Konfiguration...";

                // 3. DATEN PAKET BAUEN
                const tid = document.getElementById('tid').value;
                const pin = document.getElementById('pin').value;
                // WICHTIG: https:// entfernen, falls der User es eingegeben hat
                const cleanHost = host.replace("https://", "").replace("/", "");
                const dataStr = `${tid}|${pin}|${secret}|${cleanHost}|${ssid}|${pass}`;

                const encoder = new TextEncoder();
                const dataBytes = encoder.encode(dataStr);
                const len = dataBytes.length;
                let sum = 0x04 + len;
                for(let b of dataBytes) sum += b;
                const checksum = sum & 0xFF;

                const packet = new Uint8Array(2 + len + 1);
                packet[0] = 0x04;
                packet[1] = len;
                packet.set(dataBytes, 2);
                packet[len + 2] = checksum;

                console.log("Sende Paket (Hex):", packet);

                // 4. SENDEN
                writer = port.writable.getWriter();
                await writer.write(packet);
                writer.releaseLock();

                statusDiv.innerText = "Konfiguration GESENDET! Prüfe das Log unten.";
                statusDiv.style.color = "green";

            } catch (err) {
                console.error(err);
                statusDiv.innerText = "Fehler: " + err.message;
                statusDiv.style.color = "red";
                if (writer) writer.releaseLock();
                if (reader) reader.releaseLock();
            } finally {
                if (port && port.readable) {
                    await port.close();
                    console.log("Port geschlossen.");
                }
            }
        });
    });
</script>
</body>
</html>
