<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triton Cockpit v30 | Tag Cleaner</title>
    <script type="module">
        import { ESPLoader, Transport } from 'https://unpkg.com/esptool-js@0.5.4/bundle.js';
        window.esptoolJs = { ESPLoader, Transport };
        console.log("esptool-js v0.5.4 Bundle ready.");
    </script>
    <style>
        :root {
            --bg-core: #0b0f19;
            --bg-card: #151b2b;
            --bg-input: #1e2538;
            --primary: #3b82f6;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --border: #2d3748;
        }

        body {
            background: var(--bg-core); color: var(--text-main);
            font-family: 'Segoe UI', monospace; margin: 0; padding: 20px;
            height: 100vh; display: flex; flex-direction: column; box-sizing: border-box;
        }

        .browser-warning {
            background: #451a03; border: 2px solid var(--danger); border-radius: 8px;
            padding: 20px; text-align: center; margin-bottom: 20px;
        }
        .browser-warning h2 { color: var(--danger); margin: 0 0 10px 0; }

        header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px;
            flex-wrap: wrap; gap: 10px;
        }
        h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); }

        .profile-bar { display: flex; gap: 10px; align-items: center; }
        select { background: var(--bg-input); color: white; border: 1px solid var(--border); padding: 8px; border-radius: 4px; min-width: 150px; }
        .btn-icon {
            background: var(--bg-input); border: 1px solid var(--border); color: white;
            cursor: pointer; padding: 8px 12px; border-radius: 4px; transition: 0.2s;
        }
        .btn-icon:hover { background: var(--primary); border-color: var(--primary); }

        /* --- 3-PANE FLUID LAYOUT --- */
        .dashboard {
            display: grid;
            /* Dynamische Spaltenbreiten via CSS Custom Properties */
            grid-template-columns: var(--w-1, 420px) 4px var(--w-2, 1fr) 4px var(--w-3, 320px);
            gap: 0;
            flex: 1; min-height: 0; overflow: hidden;
        }
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr 1fr;
                --w-1: unset !important;
                --w-3: unset !important;
            }
            .resizer { display: none; }
        }
        @media (max-width: 800px) {
            .dashboard { grid-template-columns: 1fr; }
            .resizer { display: none; }
        }

        .col-left {
            display: flex; flex-direction: column; gap: 15px;
            overflow-y: auto; min-width: 200px; padding-right: 10px;
        }

        .col-middle {
            display: flex; flex-direction: column; gap: 15px;
            overflow-y: auto; min-width: 200px; min-height: 0;
        }

        .col-right {
            display: flex; flex-direction: column; gap: 15px;
            min-width: 150px; padding-left: 10px;
            height: 100%; overflow: hidden;
        }
        .col-right .card {
            flex: 1; min-height: 0; display: flex; flex-direction: column;
        }
        .col-right .history-list {
            flex: 1; min-height: 0; overflow-y: auto;
        }

        /* DRAG HANDLES / RESIZER */
        .resizer {
            background: var(--border);
            cursor: col-resize;
            transition: background 0.2s;
        }
        .resizer:hover { background: var(--primary); }

        .card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
            padding: 20px; display: flex; flex-direction: column;
        }

        h2 {
            font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase;
            border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 0;
            display: flex; justify-content: space-between; align-items: center;
        }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .full { grid-column: span 2; }

        /* MULTI-WIFI STYLES */
        .wifi-row {
            display: grid; grid-template-columns: 1fr 1fr 30px; gap: 5px; margin-bottom: 5px;
            align-items: center;
        }
        .btn-mini {
            height: 32px; width: 30px; padding: 0; display: flex; align-items: center; justify-content: center;
            background: var(--bg-input); border: 1px solid var(--border); color: #888; cursor: pointer; border-radius: 4px;
        }
        .btn-mini:hover { color: white; border-color: var(--primary); }
        .btn-add { color: var(--success); border-color: #052e16; }
        .btn-remove { color: var(--danger); border-color: #3f1515; }

        /* IMPORT BUTTON */
        .file-input { display: none; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .full { grid-column: span 1; } }

        label { display: block; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 3px; }
        input {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            color: var(--accent); padding: 8px; border-radius: 4px; box-sizing: border-box;
            font-family: monospace; font-size: 0.9rem;
        }
        input:focus { outline: none; border-color: var(--primary); }
        input[readonly] { background: #0f121a; color: #666; cursor: not-allowed; }

        .progress-container {
            height: 24px; background: #000; border-radius: 4px; overflow: hidden;
            margin: 15px 0; border: 1px solid #333; position: relative;
        }
        .progress-bar {
            height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--accent));
            transition: width 0.1s;
        }
        .progress-text {
            position: absolute; width: 100%; text-align: center; top: 0;
            font-size: 0.75rem; line-height: 24px; text-shadow: 0 0 4px black; font-weight: bold;
        }

        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 4px;
            font-weight: bold; cursor: pointer; text-transform: uppercase;
            transition: 0.2s; color: white; margin-top: auto;
        }
        .btn-flash { background: var(--primary); }
        .btn-flash:hover:not(:disabled) { background: #2563eb; }
        .btn-flash:disabled { background: var(--bg-input); color: #555; cursor: not-allowed; }

        .btn-config { background: var(--bg-input); color: #aaa; cursor: pointer; }
        .btn-config:hover { background: #2a3548; }
        .btn-config.active {
            background: var(--success); color: black; cursor: pointer;
            animation: pulse 2s infinite;
        }
        .btn-config.active:hover { background: #0d9668; }

        /* CLAIM ASSISTANT (Kompakt) */
        #claim-card {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            padding: 10px;
            display: none;
        }
        .claim-box {
            background: #000; border: 1px dashed var(--success); padding: 8px;
            border-radius: 4px; margin: 5px 0; font-family: monospace; font-size: 0.9rem;
            color: var(--success); text-align: center; cursor: pointer; user-select: all;
        }
        .claim-box:hover { background: #052e16; }
        .claim-box.copied { border-color: white; color: white; }

        .btn-telegram {
            background: #0088cc; text-decoration: none; text-align: center;
            padding: 8px; display: block; border-radius: 4px; color: white;
            font-weight: bold; font-size: 0.85rem;
        }
        .btn-telegram:hover { background: #006699; }

        /* LEDGER GRUPPEN (kein max-height - Flexbox regelt Hoehe) */
        .history-list { overflow-y: auto; margin-top: 10px; padding-right: 5px; }
        .ledger-group { border-bottom: 1px solid #333; padding: 5px 0; }
        .ledger-header {
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            padding: 8px; background: #111; border-radius: 4px;
        }
        .ledger-header:hover { background: #1a1a1a; }
        .ledger-items { display: none; padding-left: 10px; margin-top: 5px; border-left: 2px solid #333; }
        .ledger-items.open { display: block; }
        .tag-badge { background: #333; padding: 2px 6px; border-radius: 3px; font-size: 0.65rem; }
        .btn-copy-small {
            background: var(--bg-input); border: 1px solid #444; color: white;
            cursor: pointer; border-radius: 4px; padding: 4px 8px; font-size: 0.7rem;
        }
        .btn-copy-small:hover { background: var(--primary); }

        /* MONITOR */
        .monitor-container {
            display: flex; flex-direction: column; flex: 1; min-height: 200px;
            border: 1px solid var(--border); border-radius: 8px; background: #000; overflow: hidden;
        }
        .monitor-header {
            padding: 10px 15px; border-bottom: 1px solid #333;
            color: #888; font-size: 0.8rem; text-transform: uppercase;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }

        #term {
            padding: 15px; font-family: 'Consolas', monospace; font-size: 0.85rem;
            color: #ccc; flex: 1; height: 0; min-height: 0; overflow-y: auto;
            white-space: pre-wrap; scroll-behavior: smooth;
            outline: none; caret-color: var(--primary);
        }
        #term::-webkit-scrollbar { width: 10px; background: #111; }
        #term::-webkit-scrollbar-thumb { background: #333; border-radius: 5px; }
        #term:focus { background: #0a0d12; }

        /* INFO ICONS / TOOLTIPS */
        .info-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 14px; height: 14px; border-radius: 50%;
            background: #333; color: #888; font-size: 9px; font-style: normal;
            margin-left: 5px; cursor: help; border: 1px solid #555;
            vertical-align: middle;
        }
        .info-icon:hover { background: var(--primary); color: white; border-color: var(--primary); }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .empty-state {
            padding: 20px; text-align: center; color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* KNOWLEDGE BASE MODAL */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal-box {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            max-width: 600px; width: 90%; max-height: 80vh; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; border-bottom: 1px solid var(--border);
        }
        .modal-header h3 { margin: 0; color: var(--accent); font-size: 1rem; }
        .modal-close {
            background: none; border: none; color: #666; font-size: 1.5rem;
            cursor: pointer; line-height: 1;
        }
        .modal-close:hover { color: white; }
        .modal-content {
            padding: 20px; overflow-y: auto; flex: 1;
        }

        /* AKKORDEON (details/summary) */
        .modal-content details {
            border-bottom: 1px solid #333; padding: 10px 0;
        }
        .modal-content summary {
            cursor: pointer; font-weight: bold; color: var(--text-main);
            padding: 5px 0; list-style: none;
        }
        .modal-content summary::-webkit-details-marker { display: none; }
        .modal-content summary::before {
            content: 'â–¶ '; color: var(--primary); font-size: 0.8em; margin-right: 5px;
        }
        .modal-content details[open] summary::before { content: 'â–¼ '; }
        .modal-content details p {
            margin: 10px 0 5px 15px; color: var(--text-muted); font-size: 0.85rem; line-height: 1.5;
        }
    </style>
</head>
<body>

    <div id="browser-warning" class="browser-warning" style="display: none;">
        <h2>Browser nicht unterstuetzt</h2>
        <p>Web Serial API fehlt. Nutze Chrome oder Edge.</p>
    </div>

    <header>
        <h1>Triton Cockpit <span style="font-size:0.6em; color:#666;">v30 Tag Cleaner</span></h1>
        <div class="profile-bar">
            <label style="margin:0; color: var(--text-muted);">Profil:</label>
            <select id="profile-select"><option value="">-- Profil --</option></select>
            <button class="btn-icon" id="btn-save" title="Speichern">Speichern</button>
            <button class="btn-icon" id="btn-del" title="Loeschen">Loeschen</button>
        </div>
    </header>

    <div class="dashboard" id="dashboard">

        <!-- LINKE SPALTE: Flash & Config -->
        <div class="col-left">
            <div class="card">
                <h2>1. Firmware Engine</h2>
                <p style="font-size:0.75rem; color:var(--text-muted); margin:0 0 10px 0;">
                    USB einstecken. Falls Fehler: BOOT halten, RESET druecken.
                </p>
                <div class="progress-container">
                    <div id="pb-fill" class="progress-bar"></div>
                    <div id="pb-text" class="progress-text">0%</div>
                </div>
                <div id="status-text" style="text-align:center; font-size:0.8rem; color:var(--accent); margin-bottom:15px;">Bereit</div>
                <div style="display:flex; gap:10px;">
                    <button id="btn-flash" class="btn btn-flash" style="flex:1;">NUR FLASHEN</button>
                    <button id="btn-combo" class="btn btn-flash" style="flex:1; background: linear-gradient(135deg, var(--primary), var(--success));">ALL-IN-ONE</button>
                </div>
            </div>

            <div class="card">
                <h2 style="display:flex; justify-content:space-between; align-items:center;">
                    <span>2. Konfiguration <i class="info-icon" onclick="openHelp('config')">?</i></span>
                    <span style="display:flex; gap:5px;">
                        <button id="btn-lock" class="btn-icon" style="padding:2px 6px; border-color:var(--success);" title="IDs fixieren (Batch Mode)">ðŸ”’</button>
                        <button id="btn-new-ids" class="btn-icon" style="padding:2px 6px;" title="Neue IDs wuerfeln">ðŸŽ²</button>
                    </span>
                </h2>
                <div class="form-grid">
                    <div><label>TENANT ID</label><input type="text" id="tid" readonly></div>
                    <div><label>CLAIM PIN</label><input type="text" id="pin" readonly></div>
                    <div class="full"><label>TAGS</label><input type="text" id="tags" placeholder="raum, etage, typ"></div>
                    <div class="full"><label>KI KONTEXT</label><input type="text" id="desc" placeholder="Beschreibung..."></div>
                </div>
                <div style="border-top:1px solid #333; margin:10px 0;"></div>
                <label style="font-size:0.7rem; color:var(--text-muted); margin-bottom:3px;">WIFI VERBINDUNGEN <i class="info-icon" onclick="openHelp('wifi')" style="font-size:8px;">?</i></label>
                <div id="wifi-container">
                    <!-- Dynamische WiFi-Zeilen werden hier eingefuegt -->
                </div>
                <div class="form-grid" style="margin-top:10px;">
                    <div class="full">
                        <details>
                            <summary style="font-size:0.7rem; color:#666; cursor:pointer;">ERWEITERT</summary>
                            <div class="form-grid" style="margin-top:5px;">
                                <div><label>DB SECRET</label><input type="password" id="secret"></div>
                                <div><label>HOST</label><input type="text" id="host" value="triton-iot-default-rtdb.europe-west1.firebasedatabase.app"></div>
                            </div>
                        </details>
                    </div>
                </div>
                <button id="btn-config" class="btn btn-config">CONFIG SENDEN (Repair Mode)</button>
            </div>

            <!-- CLAIM ASSISTANT (kompakt, erscheint nach erfolgreicher Config) -->
            <div id="claim-card" class="card" style="display:none; border-left:4px solid var(--success); background:rgba(16,185,129,0.05); padding:12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <h2 style="color:var(--success); margin:0; border:none; padding:0; font-size:0.85rem;">
                        3. FERTIG! <i class="info-icon" onclick="openHelp('claim')">?</i>
                    </h2>
                    <button onclick="hideClaimAssistant()" style="background:none; border:none; color:#666; cursor:pointer; font-size:1rem;">&times;</button>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <div class="claim-box" id="claim-code" title="Klicken zum Kopieren" style="flex:1; margin:0; padding:6px; font-size:0.8rem;">/claim ...</div>
                    <a id="btn-telegram" href="https://t.me/IAM_Klein_Bot" target="_blank" style="background:#0088cc; color:white; padding:6px 10px; border-radius:4px; font-size:0.75rem; text-decoration:none; white-space:nowrap;">Bot &rarr;</a>
                </div>
                <div style="font-size:0.65rem; color:#666; margin-top:5px; text-align:center;">Code kopieren, Bot oeffnen, einfuegen.</div>
            </div>
        </div>

        <div class="resizer" id="drag-1"></div>

        <!-- MITTLERE SPALTE: Monitor -->
        <div class="col-middle">
            <div class="monitor-container">
                <div class="monitor-header">
                    <span>SYSTEM MONITOR</span>
                    <button id="btn-monitor" style="background:#222; color:#fff; border:1px solid #444; padding:4px 8px; font-size:0.7rem; cursor:pointer; border-radius:4px;">VERBINDEN</button>
                </div>
                <div id="term" contenteditable="true" spellcheck="false" title="Editierbar - Zeilen loeschen oder Notizen machen"></div>
            </div>
        </div>

        <div class="resizer" id="drag-2"></div>

        <!-- RECHTE SPALTE: Geraete-Historie -->
        <div class="col-right">
            <div class="card" style="flex:1;">
                <h2>
                    <span>Protokoll <i class="info-icon" onclick="openHelp('ledger')">?</i></span>
                    <span>
                        <button onclick="document.getElementById('import-file').click()" class="btn-icon" style="padding:4px 8px; font-size:0.7rem;" title="Backup laden">Import</button>
                        <input type="file" id="import-file" class="file-input" accept=".json" onchange="importData(this)">
                        <button onclick="exportData()" class="btn-icon" style="padding:4px 8px; font-size:0.7rem;" title="Backup speichern">Export</button>
                        <button id="btn-clear-history" class="btn-icon" style="padding:4px 8px; font-size:0.7rem;" title="Alle loeschen">Leeren</button>
                    </span>
                </h2>
                <p style="font-size:0.7rem; color:var(--text-muted); margin:0 0 10px 0;">
                    Alle konfigurierten Geraete. Klicke auf "Code" um den Claim-Befehl zu kopieren.
                </p>
                <div id="history-list" class="history-list">
                    <div class="empty-state">Noch keine Geraete konfiguriert.</div>
                </div>
            </div>
        </div>

    </div>

    <!-- KNOWLEDGE BASE MODAL -->
    <div id="help-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Triton Knowledge Base</h3>
                <button class="modal-close" onclick="closeHelp()">&times;</button>
            </div>
            <div class="modal-content" id="help-content">
                <!-- Inhalt wird dynamisch geladen -->
            </div>
        </div>
    </div>

<script>
(function() {
    'use strict';

    // Warte auf DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Globals
    let ESPLoader = null;
    let Transport = null;
    let espLoader = null;
    let transport = null;
    let device = null;
    let idsLocked = true; // Standard: IDs behalten fuer Batch-Modus
    let currentMac = "Unbekannt"; // MAC aus Flash-Log

    // Aktuelle Session-Daten (fuer Ledger)
    let currentSessionTid = null;
    let currentSessionPin = null;

    // --- INIT ---
    function init() {
        console.log('Triton v30 Tag Cleaner Init...');

        // 1. IDs generieren (force beim Start, damit Felder nicht leer)
        generateIds(true);

        // 2. Multi-WiFi initialisieren (MUSS vor loadProfiles kommen!)
        initWifiRows();

        // 3. Library Check
        function checkLibrary() {
            if (typeof window.esptoolJs !== 'undefined') {
                ESPLoader = window.esptoolJs.ESPLoader;
                Transport = window.esptoolJs.Transport;
                log("esptool-js geladen.", 'ok');
                return true;
            }
            return false;
        }

        if (!checkLibrary()) {
            log("Warte auf esptool-js Module...", 'sys');
            setTimeout(() => {
                if (!checkLibrary()) {
                    log("FEHLER: esptool-js nicht verfuegbar!", 'err');
                    document.getElementById('btn-flash').disabled = true;
                }
            }, 500);
        }

        // 4. Browser Check
        if (!("serial" in navigator)) {
            document.getElementById('browser-warning').style.display = 'block';
            log("WebSerial nicht unterstuetzt!", 'err');
            return;
        }

        // 5. Profile & Historie laden (nach WiFi-Init!)
        loadProfiles();
        renderHistory();

        // 6. Event Listener
        setupEventListeners();

        log("System bereit.", 'ok');
    }

    // --- MULTI-WIFI LOGIC ---
    function initWifiRows() {
        const container = document.getElementById('wifi-container');
        if (container.children.length === 0) addWifiRow();
    }

    window.addWifiRow = function(ssid = '', pass = '') {
        const container = document.getElementById('wifi-container');
        const div = document.createElement('div');
        div.className = 'wifi-row';
        const isFirst = container.children.length === 0;
        div.innerHTML = `
            <input type="text" class="wf-ssid" placeholder="SSID" value="${ssid}">
            <input type="password" class="wf-pass" placeholder="Passwort" value="${pass}">
            ${isFirst
                ? `<button type="button" class="btn-mini btn-add" onclick="addWifiRow()">+</button>`
                : `<button type="button" class="btn-mini btn-remove" onclick="this.parentElement.remove()">âˆ’</button>`}
        `;
        container.appendChild(div);
    };

    function getWifiConfig() {
        const ssids = [], passes = [];
        document.querySelectorAll('.wifi-row').forEach(row => {
            const s = row.querySelector('.wf-ssid').value.trim();
            const p = row.querySelector('.wf-pass').value;
            if (s) { ssids.push(s); passes.push(p); }
        });
        return {
            ssidStr: ssids.join(';'),
            passStr: passes.join(';'),
            list: ssids.map((s, i) => ({ ssid: s, pass: passes[i] }))
        };
    }

    // --- ID MANAGEMENT ---
    function generateIds(force = false) {
        if (idsLocked && !force) {
            log("IDs fixiert (Batch Mode).", 'sys');
            return;
        }

        const tid = document.getElementById('tid');
        const pin = document.getElementById('pin');

        tid.value = "grp_" + Math.random().toString(36).substring(2, 6);
        pin.value = Math.floor(1000 + Math.random() * 9000);

        // Session speichern
        currentSessionTid = tid.value;
        currentSessionPin = pin.value;

        // UI Feedback
        tid.style.borderColor = 'var(--accent)';
        setTimeout(() => tid.style.borderColor = '', 300);
    }

    // --- LEDGER / HISTORY SYSTEM ---
    function addToHistory(entry) {
        const history = JSON.parse(localStorage.getItem('triton_ledger') || '[]');

        // Immer neuen Eintrag hinzufuegen (fuer Batch-Tracking)
        history.unshift(entry);

        // Limit 200 Eintraege
        if (history.length > 100) history.pop();

        localStorage.setItem('triton_ledger', JSON.stringify(history));
        renderHistory();
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        const history = JSON.parse(localStorage.getItem('triton_ledger') || '[]');
        list.innerHTML = '';

        if (history.length === 0) {
            list.innerHTML = '<div class="empty-state">Leer.</div>';
            return;
        }

        // NEU: Gruppieren nach TAGS (primaer), dann TID (sekundaer)
        const tagGroups = {};
        history.forEach((item, idx) => {
            const tagKey = item.tags || 'ohne-tags';
            if (!tagGroups[tagKey]) {
                tagGroups[tagKey] = {};
            }
            if (!tagGroups[tagKey][item.tid]) {
                tagGroups[tagKey][item.tid] = { items: [], pin: item.pin, ssid: item.ssid };
            }
            tagGroups[tagKey][item.tid].items.push({ ...item, origIdx: idx });
        });

        // Render: Tag-Gruppen
        Object.keys(tagGroups).forEach(tagKey => {
            const tidGroups = tagGroups[tagKey];
            const tagDiv = document.createElement('div');
            tagDiv.className = 'ledger-group';

            // Tag Header (primaer) mit Delete-Button (v30)
            const tagHeader = document.createElement('div');
            tagHeader.className = 'ledger-header';
            const totalDevices = Object.values(tidGroups).reduce((sum, g) => sum + g.items.length, 0);

            tagHeader.innerHTML = `
                <div style="flex:1;">
                    <strong style="color:var(--warning);">${tagKey}</strong>
                    <span style="font-size:0.7rem; color:#888;"> (${totalDevices} Geraete)</span>
                </div>
                <button class="btn-copy-small btn-del-tag" style="background:#3f1515; margin-left:10px;" title="Alle Geraete dieser Tag-Gruppe loeschen">X</button>
            `;

            // Toggle Event (nicht bei Button-Klick)
            tagHeader.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') return;
                tagDiv.querySelector('.ledger-items').classList.toggle('open');
            });

            // Delete Tag Event
            tagHeader.querySelector('.btn-del-tag').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteTag(tagKey);
            });

            tagDiv.appendChild(tagHeader);

            // TID Sub-Gruppen (sekundaer)
            const tidContainer = document.createElement('div');
            tidContainer.className = 'ledger-items';

            Object.keys(tidGroups).forEach(tid => {
                const g = tidGroups[tid];
                const claimCmd = `/claim ${tid} ${g.pin}`;

                const tidDiv = document.createElement('div');
                tidDiv.style.cssText = 'margin: 5px 0; padding: 8px; background: #0a0d12; border-radius: 4px;';

                // TID Header (sekundaer) - mit WiFi-Info
                const tidHeader = document.createElement('div');
                tidHeader.style.cssText = 'display:flex; justify-content:space-between; align-items:center; cursor:pointer;';
                const wifiDisplay = g.items[0].wifi
                    ? `ðŸ“¶ ${g.items[0].wifi[0].ssid}${g.items[0].wifi.length > 1 ? ' (+' + (g.items[0].wifi.length - 1) + ')' : ''}`
                    : (g.items[0].ssid ? `ðŸ“¶ ${g.items[0].ssid}` : '');
                tidHeader.innerHTML = `
                    <div>
                        <span style="color:var(--accent); font-family:monospace;">${tid}</span>
                        <span style="font-size:0.65rem; color:#666;"> (${g.items.length}x)</span>
                        ${wifiDisplay ? `<span style="font-size:0.6rem; color:#555; margin-left:8px;">${wifiDisplay}</span>` : ''}
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-copy-small btn-restore" title="IDs laden">Laden</button>
                        <button class="btn-copy-small btn-claim" title="${claimCmd}">Code</button>
                        <button class="btn-copy-small btn-delete-batch" title="Batch loeschen" style="background:#3f1515;">X</button>
                    </div>
                `;

                // Buttons
                tidHeader.querySelector('.btn-restore').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('tid').value = tid;
                    document.getElementById('pin').value = g.pin;
                    log(`Batch '${tid}' geladen.`, 'ok');
                });
                tidHeader.querySelector('.btn-claim').addEventListener('click', (e) => {
                    e.stopPropagation();
                    navigator.clipboard.writeText(claimCmd);
                    log(`Kopiert: ${claimCmd}`, 'ok');
                });
                tidHeader.querySelector('.btn-delete-batch').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteBatch(tid);
                });

                // Toggle Device List
                tidHeader.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') return;
                    const devList = tidDiv.querySelector('.device-list');
                    if (devList) devList.classList.toggle('open');
                });

                tidDiv.appendChild(tidHeader);

                // Device Liste mit Info-Button
                const devList = document.createElement('div');
                devList.className = 'ledger-items device-list';
                devList.style.cssText = 'margin-top:5px; padding-left:10px; border-left:2px solid #333;';
                g.items.forEach(item => {
                    const itemRow = document.createElement('div');
                    itemRow.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:3px 0; font-size:0.7rem;';
                    itemRow.innerHTML = `
                        <div>
                            <span style="color:#aaa;">${item.mac || 'Keine MAC'}</span>
                            <span style="color:#444; margin-left:8px;">${item.timestamp}</span>
                        </div>
                        <div style="display:flex; gap:3px;">
                            <button class="btn-info-detail" style="background:none; border:1px solid #444; color:#888; cursor:pointer; font-size:0.65rem; padding:2px 5px; border-radius:3px;" title="Details anzeigen">i</button>
                            <button class="btn-del-single" style="background:none; border:none; color:#555; cursor:pointer; font-size:0.8rem;">Ã—</button>
                        </div>
                    `;
                    itemRow.querySelector('.btn-info-detail').onclick = (e) => { e.stopPropagation(); showDeviceDetails(item.origIdx); };
                    itemRow.querySelector('.btn-del-single').onclick = (e) => { e.stopPropagation(); deleteHistoryItem(item.origIdx); };
                    devList.appendChild(itemRow);
                });
                tidDiv.appendChild(devList);

                tidContainer.appendChild(tidDiv);
            });

            tagDiv.appendChild(tidContainer);
            list.appendChild(tagDiv);
        });
    }

    function clearHistory() {
        if (confirm('Alle Geraete-Eintraege loeschen?')) {
            localStorage.removeItem('triton_ledger');
            renderHistory();
            log("Historie geloescht.", 'sys');
        }
    }

    // --- CLAIM ASSISTANT ---
    function showClaimAssistant(tid, pin) {
        const card = document.getElementById('claim-card');
        const codeBox = document.getElementById('claim-code');

        const cmd = `/claim ${tid} ${pin}`;
        codeBox.textContent = cmd;
        card.style.display = 'flex';

        // Click to copy
        codeBox.onclick = () => {
            navigator.clipboard.writeText(cmd);
            codeBox.classList.add('copied');
            codeBox.textContent = 'KOPIERT!';
            setTimeout(() => {
                codeBox.classList.remove('copied');
                codeBox.textContent = cmd;
            }, 1500);
            log(`Claim-Code kopiert: ${cmd}`, 'ok');
        };
    }

    function hideClaimAssistant() {
        document.getElementById('claim-card').style.display = 'none';
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        document.getElementById('btn-flash').addEventListener('click', handleFlash);
        document.getElementById('btn-config').addEventListener('click', handleConfig);
        document.getElementById('btn-save').addEventListener('click', saveProfile);
        document.getElementById('btn-del').addEventListener('click', deleteProfile);
        document.getElementById('profile-select').addEventListener('change', loadSelectedProfile);
        document.getElementById('btn-clear-history').addEventListener('click', clearHistory);

        // Lock Button
        document.getElementById('btn-lock').addEventListener('click', function() {
            idsLocked = !idsLocked;
            this.textContent = idsLocked ? 'ðŸ”’' : 'ðŸ”“';
            this.style.borderColor = idsLocked ? 'var(--success)' : 'var(--danger)';
            log(idsLocked ? 'IDs fixiert (Batch Mode).' : 'IDs entsperrt.', 'sys');
        });

        // New IDs Button
        document.getElementById('btn-new-ids').addEventListener('click', () => generateIds(true));

        // ALL-IN-ONE Button
        document.getElementById('btn-combo').addEventListener('click', handleCombo);
    }

    // --- ALL-IN-ONE FLOW ---
    async function handleCombo() {
        log("ALL-IN-ONE Prozess gestartet...", 'sys');
        const btnCombo = document.getElementById('btn-combo');
        btnCombo.disabled = true;
        btnCombo.innerText = "Flashe...";

        try {
            // 1. Flash ausfuehren
            await handleFlash();

            // Pruefen ob Flash erfolgreich war (anhand Button-Text)
            const btnFlash = document.getElementById('btn-flash');
            if (btnFlash.innerText.includes('Fehler')) {
                throw new Error('Flash fehlgeschlagen');
            }

            // 2. Warten auf ESP Reboot
            log("Warte auf ESP Reboot (3s)...", 'sys');
            btnCombo.innerText = "Warte...";
            await new Promise(r => setTimeout(r, 3000));

            // 3. Config senden
            log("Starte Auto-Config...", 'sys');
            btnCombo.innerText = "Config...";
            await handleConfig();

            log("ALL-IN-ONE abgeschlossen!", 'ok');
        } catch (e) {
            log("ALL-IN-ONE Fehler: " + e.message, 'err');
        } finally {
            btnCombo.disabled = false;
            btnCombo.innerText = "ALL-IN-ONE";
        }
    }

    // --- LOG ---
    function log(msg, type) {
        const term = document.getElementById('term');
        if (!term) { console.log(msg); return; }

        const div = document.createElement('div');
        const time = new Date().toLocaleTimeString();
        div.textContent = `[${time}] ${msg}`;

        if (type === 'err') div.style.color = '#f87171';
        else if (type === 'ok') div.style.color = '#4ade80';
        else if (type === 'sys') div.style.color = '#38bdf8';

        // Smart Scroll: Nur scrollen wenn User nicht fokussiert oder am Ende
        const isFocused = (document.activeElement === term);
        const isAtBottom = (term.scrollHeight - term.scrollTop - term.clientHeight) < 50;

        term.appendChild(div);

        // Scrollen ausser User editiert gerade weiter oben
        if (!isFocused || isAtBottom) {
            term.scrollTop = term.scrollHeight;
        }
    }

    function setProgress(percent, msg) {
        document.getElementById('pb-fill').style.width = percent + '%';
        document.getElementById('pb-text').textContent = Math.round(percent) + '%';
        if (msg) document.getElementById('status-text').textContent = msg;
    }

    // --- MANIFEST ---
    async function getFirmwareFiles() {
        try {
            log("Lade manifest.json...", 'sys');
            const resp = await fetch('manifest.json');
            if (!resp.ok) throw new Error("manifest.json nicht gefunden!");

            const manifest = await resp.json();
            const build = manifest.builds[0];
            log(`Chip: ${build.chipFamily}`, 'sys');

            const fileArray = [];
            for (const part of build.parts) {
                log(`Lade ${part.path}...`, 'sys');
                const binResp = await fetch(part.path);
                if (!binResp.ok) throw new Error(`${part.path} fehlt!`);

                const blob = await binResp.blob();
                const data = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsBinaryString(blob);
                });

                fileArray.push({ data: data, address: Number(part.offset) });
            }
            return fileArray;
        } catch (e) {
            log(e.message, 'err');
            return null;
        }
    }

    // --- FLASH ---
    async function handleFlash() {
        log("Flash gestartet...", 'sys');
        hideClaimAssistant();

        if (!ESPLoader || !Transport) {
            log("Library nicht geladen!", 'err');
            return;
        }

        const btnFlash = document.getElementById('btn-flash');
        btnFlash.disabled = true;
        btnFlash.innerText = "Lade...";

        const fileArray = await getFirmwareFiles();
        if (!fileArray) {
            btnFlash.disabled = false;
            btnFlash.innerText = "VERBINDEN & FLASHEN";
            return;
        }

        try {
            log("Waehle Serial Port...", 'sys');
            device = await navigator.serial.requestPort({ filters: [{ usbVendorId: 0x303a }] });

            transport = new Transport(device, true);

            // Terminal Hook mit MAC-Parser
            const termStub = {
                clean: () => {},
                writeLine: (l) => {
                    log(l, 'sys');
                    // MAC-Adresse aus Log parsen
                    if (l.includes('MAC:')) {
                        const match = l.match(/MAC:\s*([0-9a-fA-F:]+)/);
                        if (match) {
                            currentMac = match[1];
                            log(`MAC erkannt: ${currentMac}`, 'ok');
                        }
                    }
                },
                write: () => {}
            };

            log("Verbinde mit Bootloader...", 'sys');
            btnFlash.innerText = "Bootloader...";
            setProgress(5, "Verbinde...");

            espLoader = new ESPLoader({
                transport: transport,
                baudrate: 921600,
                terminal: termStub
            });

            const chip = await espLoader.main('default_reset', 'default_reset', 'dio', 'dio');
            log(`Chip: ${chip}`, 'ok');
            setProgress(10, "Chip OK");

            log("Starte Flash...", 'sys');
            btnFlash.innerText = "Flashen...";

            await espLoader.writeFlash({
                fileArray: fileArray,
                flashSize: 'keep',
                flashMode: 'dio',
                flashFreq: '80m',
                eraseAll: false,
                compress: true,
                reportProgress: (idx, written, total) => {
                    const pct = 10 + ((written / total) * 85);
                    setProgress(pct, `Flash: ${Math.round((written/total)*100)}%`);
                }
            });

            setProgress(100, "Flash OK!");
            log("Firmware geschrieben.", 'ok');
            btnFlash.innerText = "Flash OK";

            // Soft Reset
            log("Soft-Reset...", 'sys');
            await transport.setDTR(false);
            await transport.setRTS(true);
            await new Promise(r => setTimeout(r, 100));
            await transport.setDTR(true);
            await transport.setRTS(false);

            try { await transport.disconnect(); } catch (e) {}
            try { await device.close(); } catch (e) {}

            transport = null;
            espLoader = null;
            device = null;

            log("Port freigegeben.", 'sys');

            // Config Button aktivieren
            const btnConf = document.getElementById('btn-config');
            btnConf.disabled = false;
            btnConf.classList.add('active');
            btnConf.innerText = "KONFIGURATION SENDEN";

            btnFlash.disabled = false;
            btnFlash.innerText = "NAECHSTES FLASHEN";
            log("Bereit fuer Config oder naechstes Geraet.", 'sys');

        } catch (e) {
            log("Flash Fehler: " + e.message, 'err');
            console.error(e);
            setProgress(0, "Fehler");
            btnFlash.innerText = "Fehler - Retry";
            btnFlash.disabled = false;

            try { if (transport) await transport.disconnect(); } catch (ex) {}
            try { if (device) await device.close(); } catch (ex) {}
            transport = null;
            espLoader = null;
            device = null;
        }
    }

    // --- CONFIG ENGINE (Seamless Port Handover) ---
    async function handleConfig() {
        // MULTI-WIFI: Daten sammeln
        const wifiData = getWifiConfig();
        if (!wifiData.ssidStr) {
            log("Mindestens eine SSID eingeben!", 'err');
            alert("Bitte mindestens eine SSID eingeben!");
            return;
        }

        // Stoppe Monitor falls aktiv (wir brauchen Port exklusiv)
        if (isMonitoring && monitorReader) {
            log("Pausiere Monitor fuer Config...", 'sys');
            isMonitoring = false;
            try { await monitorReader.cancel(); monitorReader.releaseLock(); } catch(e){}
            monitorReader = null;
            // WICHTIG: Port NICHT schliessen - wir uebernehmen ihn!
        }

        const btnConf = document.getElementById('btn-config');
        btnConf.classList.remove('active');
        btnConf.innerText = "Verbinde...";

        // Aktuelle IDs merken BEVOR sie regeneriert werden
        const tid = document.getElementById('tid').value;
        const pin = document.getElementById('pin').value;
        const tags = document.getElementById('tags').value.replace(/\|/g, ",") || "neu";
        const desc = document.getElementById('desc').value.replace(/\|/g, " ") || "n/a";

        let portToUse = monitorPort; // Versuche existierenden Port
        let writer = null;
        let configSuccess = false;

        try {
            // SMART PORT CHECK
            if (!portToUse || !portToUse.writable) {
                // Versuche vorhandene Ports zu finden (Re-Connect nach Reset)
                const ports = await navigator.serial.getPorts();
                if (ports.length > 0) {
                    portToUse = ports[0];
                    log("Bekannten Port gefunden.", 'sys');
                } else {
                    log("Kein offener Port. Fordere an...", 'sys');
                    portToUse = await navigator.serial.requestPort();
                }

                // Nur oeffnen wenn nicht schon offen
                try {
                    await portToUse.open({ baudRate: 115200 });
                } catch(openErr) {
                    if (!openErr.message.includes('already open')) throw openErr;
                    log("Port bereits offen.", 'sys');
                }
            } else {
                log("Nutze offenen Port...", 'sys');
            }

            // V2 Protocol - Data Prep (Multi-WiFi: SSID;SSID2|PASS;PASS2)
            const secret = document.getElementById('secret').value;
            const host = document.getElementById('host').value.replace("https://", "").replace(/\/$/g, "");

            const raw = `${tid}|${pin}|${secret}|${host}|${wifiData.ssidStr}|${wifiData.passStr}|${tags}|${desc}`;
            const enc = new TextEncoder().encode(raw);

            let sum = 0x04 + enc.length;
            for (let b of enc) sum += b;

            const packet = new Uint8Array(enc.length + 3);
            packet[0] = 0x04;
            packet[1] = enc.length;
            packet.set(enc, 2);
            packet[packet.length - 1] = sum & 0xFF;

            log(`Sende ${enc.length} Bytes (${wifiData.list.length} WLAN)...`, 'sys');
            btnConf.innerText = "Sende...";

            writer = portToUse.writable.getWriter();
            await writer.write(packet);
            writer.releaseLock();
            writer = null;

            log("CONFIG GESENDET!", 'ok');
            configSuccess = true;

            // --- ERFOLG: FULL DATA SAVE (mit WiFi-Liste, Host, Secret) ---
            addToHistory({
                timestamp: new Date().toLocaleString('de-DE'),
                tid: tid,
                pin: pin,
                tags: tags,
                desc: desc,
                mac: currentMac,
                wifi: wifiData.list,
                host: host,
                secret: secret
            });
            currentMac = "Unbekannt"; // Reset fuer naechstes Geraet

            showClaimAssistant(tid, pin);

            // UI fuer naechstes Geraet
            btnConf.classList.remove('active');
            btnConf.innerText = "CONFIG SENDEN";
            btnConf.style.background = "";
            btnConf.style.color = "";

            generateIds();
            log("Neue IDs generiert.", 'sys');
            document.getElementById('btn-flash').innerText = "NAECHSTES FLASHEN";

            // AUTO-MONITOR: Port offen lassen und Monitor starten
            log("Starte Auto-Monitor...", 'sys');
            startMonitorLoop(portToUse);

        } catch (e) {
            log("Config Fehler: " + e.message, 'err');
            btnConf.innerText = "Retry Config";
            if (writer) try { writer.releaseLock(); } catch(ex){}
            // Im Fehlerfall Port schliessen
            try { if(portToUse && portToUse !== monitorPort) await portToUse.close(); } catch(ex){}
        }
    }

    // --- PROFILE ---
    // FIX v29.1: ssid/pass entfernt - werden jetzt dynamisch via wifi-container behandelt
    const pFields = ['host', 'secret', 'tags', 'desc'];

    function loadProfiles() {
        const pSel = document.getElementById('profile-select');
        if (!pSel) return;

        const d = JSON.parse(localStorage.getItem('triton_profiles') || '{}');
        const lastUsed = localStorage.getItem('triton_last_profile');

        pSel.innerHTML = '<option value="">-- Profil laden --</option>';
        const keys = Object.keys(d);

        keys.forEach(k => {
            const o = document.createElement('option');
            o.value = k;
            o.innerText = k;
            pSel.appendChild(o);
        });

        // AUTO-SELECT: Letztes Profil oder erstes verfuegbares
        if (keys.length > 0) {
            if (lastUsed && d[lastUsed]) {
                pSel.value = lastUsed;
            } else {
                pSel.value = keys[0];
            }
            // Trigger Change um Felder zu fuellen
            loadSelectedProfile();
            log(`Profil '${pSel.value}' auto-geladen.`, 'sys');
        }
    }

    function saveProfile() {
        const n = prompt("Profilname:");
        if (!n) return;

        const d = JSON.parse(localStorage.getItem('triton_profiles') || '{}');
        const wifiData = getWifiConfig(); // Holt Daten aus dynamischen Zeilen

        d[n] = {
            // WiFi-Liste speichern (neues Format)
            wifi: wifiData.list,
            // Legacy-Felder fuer Abwaertskompatibilitaet
            ssid: wifiData.list[0]?.ssid || '',
            pass: wifiData.list[0]?.pass || '',
            // Standard-Felder
            host: document.getElementById('host').value,
            secret: document.getElementById('secret').value,
            tags: document.getElementById('tags').value,
            desc: document.getElementById('desc').value
        };

        localStorage.setItem('triton_profiles', JSON.stringify(d));
        localStorage.setItem('triton_last_profile', n);
        loadProfiles();
        document.getElementById('profile-select').value = n;
        log(`Profil '${n}' gespeichert.`, 'ok');
    }

    function deleteProfile() {
        const pSel = document.getElementById('profile-select');
        const n = pSel.value;
        if (!n) { log("Kein Profil gewaehlt.", 'err'); return; }

        if (confirm(`'${n}' loeschen?`)) {
            const d = JSON.parse(localStorage.getItem('triton_profiles') || '{}');
            delete d[n];
            localStorage.setItem('triton_profiles', JSON.stringify(d));
            loadProfiles();
            log(`Profil geloescht.`, 'sys');
        }
    }

    function loadSelectedProfile() {
        const pSel = document.getElementById('profile-select');
        const n = pSel.value;
        if (!n) return;

        const d = JSON.parse(localStorage.getItem('triton_profiles') || '{}');
        const data = d[n];

        if (data) {
            // 1. Standard-Felder fuellen (Host, Tags, etc.)
            pFields.forEach(f => {
                const el = document.getElementById(f);
                if (el) el.value = data[f] || '';
            });

            // 2. WiFi-Felder fuellen (Spezialbehandlung fuer Multi-WiFi)
            const container = document.getElementById('wifi-container');
            container.innerHTML = ''; // Reset

            if (data.wifi && Array.isArray(data.wifi)) {
                // Neues Format (Liste)
                data.wifi.forEach(w => addWifiRow(w.ssid, w.pass));
            } else if (data.ssid) {
                // Altes Format (Legacy Support)
                addWifiRow(data.ssid, data.pass);
            } else {
                // Fallback leer
                addWifiRow();
            }

            localStorage.setItem('triton_last_profile', n);
            log(`Profil '${n}' geladen.`, 'sys');
        }
    }

    // --- LIVE MONITOR ---
    let monitorReader = null;
    let monitorPort = null;
    let isMonitoring = false;

    // Extrahierte Monitor-Loop Funktion fuer Seamless Handover
    async function startMonitorLoop(existingPort) {
        const btn = document.getElementById('btn-monitor');
        try {
            // Port Uebernahme oder Neuverbindung
            if (existingPort && existingPort.readable) {
                monitorPort = existingPort;
                log("Monitor: Port uebernommen.", 'sys');
            } else {
                log("Monitor: Fordere Port an...", 'sys');
                monitorPort = await navigator.serial.requestPort();
                await monitorPort.open({ baudRate: 115200 });
            }

            isMonitoring = true;
            btn.innerText = "STOPP";
            btn.style.background = "var(--danger)";
            log("Monitor aktiv (115200 Baud)", 'ok');

            const decoder = new TextDecoderStream();
            monitorPort.readable.pipeTo(decoder.writable);
            const reader = decoder.readable.getReader();
            monitorReader = reader;

            while (isMonitoring) {
                const { value, done } = await reader.read();
                if (done) break;
                if (value && value.trim()) log(`[ESP] ${value.trim()}`, 'sys');
            }

        } catch (e) {
            log("Monitor: " + e.message, 'err');
            if (e.message.includes("already open") || e.message.includes("Resource busy")) {
                log("TIPP: Reset-Taster am ESP druecken.", 'sys');
            }
            isMonitoring = false;
            btn.innerText = "VERBINDEN";
            btn.style.background = "#222";
        }
    }

    async function stopMonitor() {
        isMonitoring = false;
        try {
            if (monitorReader) { await monitorReader.cancel(); monitorReader.releaseLock(); }
            if (monitorPort) await monitorPort.close();
        } catch (e) {}
        monitorPort = null;
        monitorReader = null;
        const btn = document.getElementById('btn-monitor');
        btn.innerText = "VERBINDEN";
        btn.style.background = "#222";
    }

    document.getElementById('btn-monitor').addEventListener('click', async () => {
        if (isMonitoring) {
            await stopMonitor();
            log("Monitor gestoppt.", 'sys');
        } else {
            startMonitorLoop(null); // Null = Neuen Port anfordern
        }
    });

    // --- RESIZER LOGIC ---
    const dashboard = document.getElementById('dashboard');

    function makeResizable(resizerId, colVar, isRightSide) {
        const resizer = document.getElementById(resizerId);
        if (!resizer) return;

        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';

            const startX = e.clientX;
            const targetCol = isRightSide ? resizer.nextElementSibling : resizer.previousElementSibling;
            const startW = targetCol.offsetWidth;

            const onMove = (e) => {
                let newW;
                if (isRightSide) {
                    // Rechte Spalte: Nach links ziehen = groesser
                    newW = startW - (e.clientX - startX);
                } else {
                    // Linke Spalte: Nach rechts ziehen = groesser
                    newW = startW + (e.clientX - startX);
                }
                // Min-Width beachten
                newW = Math.max(newW, 150);
                newW = Math.min(newW, window.innerWidth * 0.5);
                dashboard.style.setProperty(colVar, newW + 'px');
            };

            const onUp = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            };

            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        });
    }

    // Init Resizers
    makeResizable('drag-1', '--w-1', false); // Linke Spalte
    makeResizable('drag-2', '--w-3', true);  // Rechte Spalte

    // --- BATCH DELETE ---
    function deleteBatch(tid) {
        if (!confirm(`Batch '${tid}' und ALLE zugehoerigen Geraete loeschen?`)) return;
        let history = JSON.parse(localStorage.getItem('triton_ledger') || '[]');
        history = history.filter(item => item.tid !== tid);
        localStorage.setItem('triton_ledger', JSON.stringify(history));
        renderHistory();
        log(`Batch '${tid}' geloescht.`, 'sys');
    }

    // --- TAG DELETE (v30) ---
    window.deleteTag = function(tagKey) {
        if (!confirm(`ACHTUNG: Alle Geraete mit Tag '${tagKey}' unwiderruflich loeschen?`)) return;

        let db = JSON.parse(localStorage.getItem('triton_ledger') || '[]');
        const before = db.length;

        // Filterlogik: Behalte alles, was NICHT diesen Tag-Key hat
        db = db.filter(item => {
            const currentKey = item.tags || 'ohne-tags';
            return currentKey !== tagKey;
        });

        const deleted = before - db.length;
        localStorage.setItem('triton_ledger', JSON.stringify(db));
        renderHistory();
        log(`${deleted} Geraete (Tag: ${tagKey}) geloescht.`, 'sys');
    };

    // --- EXPORT FUNKTION ---
    window.exportData = function() {
        const data = {
            profiles: JSON.parse(localStorage.getItem('triton_profiles') || '{}'),
            ledger: JSON.parse(localStorage.getItem('triton_ledger') || '[]'),
            exportedAt: new Date().toISOString(),
            version: 'v30'
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `triton_backup_${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        log("Backup exportiert.", 'ok');
    };

    // --- HISTORY DELETE EINZELN ---
    window.deleteHistoryItem = function(index) {
        if (!confirm("Eintrag loeschen?")) return;
        const history = JSON.parse(localStorage.getItem('triton_ledger') || '[]');
        history.splice(index, 1);
        localStorage.setItem('triton_ledger', JSON.stringify(history));
        renderHistory();
        log("Eintrag geloescht.", 'sys');
    };

    // --- KNOWLEDGE BASE MODAL ---
    const helpTopics = {
        config: {
            title: 'Konfiguration',
            content: `
                <details open>
                    <summary>Was ist die Tenant ID?</summary>
                    <p>Die Tenant ID (TID) ist eine Gruppen-ID fuer mehrere Geraete. Alle Geraete mit derselben TID gehoeren zusammen und koennen gemeinsam verwaltet werden.</p>
                </details>
                <details>
                    <summary>Was ist der Claim PIN?</summary>
                    <p>Der PIN ist ein 4-stelliger Sicherheitscode, der verhindert, dass Fremde dein Geraet uebernehmen. Du brauchst ihn zusammen mit der TID um das Geraet zu "claimen".</p>
                </details>
                <details>
                    <summary>Was sind Tags?</summary>
                    <p>Tags helfen dir, Geraete zu organisieren. Beispiele: "wohnzimmer", "erdgeschoss", "pumpe". Sie erscheinen im Protokoll und erleichtern die Uebersicht bei vielen Geraeten.</p>
                </details>
                <details>
                    <summary>Was ist der KI Kontext?</summary>
                    <p>Eine Beschreibung fuer KI-Assistenten. Erklaere hier, was das Geraet steuert, z.B. "Poolpumpe im Garten" oder "Licht Flur OG".</p>
                </details>
            `
        },
        claim: {
            title: 'Geraet Claimen',
            content: `
                <details open>
                    <summary>Was bedeutet "Claimen"?</summary>
                    <p>Das Geraet mit deinem Telegram-Account verknuepfen. Erst nach dem Claim kannst du es per Telegram steuern.</p>
                </details>
                <details>
                    <summary>Wie funktioniert es?</summary>
                    <p>1. Kopiere den Claim-Code (z.B. "/claim grp_abc1 1234")<br>
                    2. Oeffne den Telegram-Bot<br>
                    3. Fuege den Code ein und sende ihn</p>
                </details>
                <details>
                    <summary>Code funktioniert nicht?</summary>
                    <p>Pruefe: Ist das Geraet im WLAN? Hat es Internet? Warte 30 Sekunden nach dem Config-Senden und versuche es erneut.</p>
                </details>
            `
        },
        ledger: {
            title: 'Protokoll / Ledger',
            content: `
                <details open>
                    <summary>Was ist das Protokoll?</summary>
                    <p>Eine lokale Historie aller konfigurierten Geraete. Gruppiert nach Tags und TID fuer bessere Uebersicht.</p>
                </details>
                <details>
                    <summary>Batch Mode?</summary>
                    <p>Bei aktiviertem Lock-Symbol bleiben TID und PIN gleich. Ideal fuer Serienproduktion: Mehrere Geraete, ein Claim-Code.</p>
                </details>
                <details>
                    <summary>Export / Backup</summary>
                    <p>Der Export-Button speichert alle Profile und das Protokoll als JSON-Datei. Nuetzlich als Backup oder fuer Dokumentation.</p>
                </details>
                <details>
                    <summary>Import</summary>
                    <p>Lade ein Backup um Profile und Geraete wiederherzustellen. Duplikate werden automatisch erkannt und uebersprungen.</p>
                </details>
            `
        },
        wifi: {
            title: 'Multi-WiFi Verbindungen',
            content: `
                <details open>
                    <summary>Mehrere WLANs konfigurieren</summary>
                    <p>Mit dem + Button kannst du weitere WLAN-Zugangsdaten hinzufuegen. Das Geraet versucht dann alle Netzwerke der Reihe nach.</p>
                </details>
                <details>
                    <summary>Wann ist das nuetzlich?</summary>
                    <p>Ideal fuer mobile Geraete oder wenn du Backup-Netzwerke haben willst (z.B. Haupt-WLAN + Hotspot).</p>
                </details>
                <details>
                    <summary>Reihenfolge</summary>
                    <p>Das erste WLAN in der Liste wird zuerst versucht. Falls es nicht erreichbar ist, wird das naechste probiert.</p>
                </details>
            `
        }
    };

    window.openHelp = function(topic) {
        const modal = document.getElementById('help-modal');
        const content = document.getElementById('help-content');
        const data = helpTopics[topic];

        if (data) {
            content.innerHTML = `<h4 style="color:var(--accent); margin-top:0;">${data.title}</h4>${data.content}`;
        } else {
            content.innerHTML = '<p>Thema nicht gefunden.</p>';
        }

        modal.classList.add('open');
    };

    window.closeHelp = function() {
        document.getElementById('help-modal').classList.remove('open');
    };

    // Schliessen bei Klick auf Overlay
    document.getElementById('help-modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) closeHelp();
    });

    // --- DEVICE DETAILS MODAL ---
    window.showDeviceDetails = function(idx) {
        const history = JSON.parse(localStorage.getItem('triton_ledger') || '[]');
        const item = history[idx];
        if (!item) return;

        // WiFi-Anzeige (Multi-WiFi oder Legacy)
        const wifiHtml = item.wifi
            ? item.wifi.map(w => `<div style="margin:3px 0;">ðŸ“¶ <strong>${w.ssid}</strong> <span style="color:#666;">(${w.pass ? '****' : 'kein PW'})</span></div>`).join('')
            : `<div>ðŸ“¶ ${item.ssid || '-'}</div>`;

        const content = `
            <div style="font-size:0.9rem; color:#ccc;">
                <div style="background:#111; padding:12px; border-radius:6px; margin-bottom:15px;">
                    <div style="color:var(--accent); font-weight:bold; font-size:1.1rem;">${item.tid}</div>
                    <div style="font-family:monospace; font-size:0.85rem; margin-top:5px;">PIN: <strong>${item.pin}</strong></div>
                    <div style="font-family:monospace; font-size:0.75rem; margin-top:8px; color:#666;">MAC: ${item.mac || 'nicht erfasst'}</div>
                    <div style="font-size:0.7rem; color:#555; margin-top:5px;">${item.timestamp}</div>
                </div>

                <h4 style="margin:15px 0 8px 0; color:var(--text-main); border-bottom:1px solid #333; padding-bottom:5px;">Netzwerk</h4>
                <div style="margin-bottom:15px;">${wifiHtml}</div>

                <h4 style="margin:15px 0 8px 0; color:var(--text-main); border-bottom:1px solid #333; padding-bottom:5px;">Backend</h4>
                <div style="font-family:monospace; font-size:0.8rem; word-break:break-all; background:#0a0d12; padding:8px; border-radius:4px;">
                    Host: ${item.host || 'Standard'}<br>
                    Secret: ${item.secret ? 'â—â—â—â—â—â—' : '-'}
                </div>

                <h4 style="margin:15px 0 8px 0; color:var(--text-main); border-bottom:1px solid #333; padding-bottom:5px;">Kontext</h4>
                <div style="font-style:italic; color:#aaa; margin-bottom:8px;">"${item.desc || '-'}"</div>
                <div><span class="tag-badge" style="background:#333; padding:3px 8px; border-radius:4px;">${item.tags}</span></div>
            </div>
        `;

        const modal = document.getElementById('help-modal');
        document.getElementById('help-content').innerHTML = `<h4 style="color:var(--accent); margin-top:0;">Geraete-Details</h4>${content}`;
        modal.classList.add('open');
    };

    // --- IMPORT FUNKTION ---
    window.importData = function(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);

                // 1. Merge Profiles
                if (data.profiles) {
                    const currentProfs = JSON.parse(localStorage.getItem('triton_profiles') || '{}');
                    Object.assign(currentProfs, data.profiles);
                    localStorage.setItem('triton_profiles', JSON.stringify(currentProfs));
                    loadProfiles();
                    log(`${Object.keys(data.profiles).length} Profile importiert.`, 'ok');
                }

                // 2. Merge Ledger (Smart: Duplikate via Timestamp+TID erkennen)
                if (data.ledger && data.ledger.length > 0) {
                    let currentLedger = JSON.parse(localStorage.getItem('triton_ledger') || '[]');
                    const signatures = new Set(currentLedger.map(i => i.timestamp + i.tid));

                    let added = 0;
                    data.ledger.forEach(entry => {
                        if (!signatures.has(entry.timestamp + entry.tid)) {
                            currentLedger.push(entry);
                            signatures.add(entry.timestamp + entry.tid);
                            added++;
                        }
                    });

                    localStorage.setItem('triton_ledger', JSON.stringify(currentLedger));
                    renderHistory();
                    log(`${added} Geraete importiert (${data.ledger.length - added} Duplikate).`, 'ok');
                }

                log("Import abgeschlossen.", 'ok');
            } catch (err) {
                log("Import Fehler: " + err.message, 'err');
                alert("Fehler beim Import: " + err.message);
            }
            input.value = ''; // Reset file input
        };
        reader.readAsText(file);
    };

})();
</script>
</body>
</html>
