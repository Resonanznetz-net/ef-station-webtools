<!DOCTYPE html>
<html>
<head>
    <title>Triton Flash & Configure</title>
    <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
    <style>
        body { font-family: sans-serif; padding: 2rem; }
        .hidden { display: none; }
        button { padding: 10px 20px; font-size: 16px; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Triton v8.4 Flasher</h1>

    <!-- Step 1: Flash Firmware -->
<div id="flash-section">
        <esp-web-install-button
            manifest="manifest.json"
        ></esp-web-install-button>
    </div>

    <button id="btn-force-show" style="margin-top: 40px; background: #f0f0f0; color: #666; font-size: 0.8em; border: 1px solid #ccc;">
        ⚠️ Manuelle Konfiguration öffnen (falls Popup fehlt)
    </button>

    <div id="config-section" class="hidden">
        <h2>Configuration</h2>
        <p>Firmware installed. Now configure the device.</p>

        <label>Tenant ID (Auto): <input type="text" id="tid" readonly></label><br><br>
        <label>Claim PIN (Auto): <input type="text" id="pin" readonly></label><br><br>
        <label>DB Secret: <input type="password" id="secret"></label><br><br>
        <label>Firebase Host: <input type="text" id="host"></label><br><br>
        <label>WiFi SSID: <input type="text" id="ssid"></label><br><br>
        <label>WiFi Password: <input type="password" id="pass"></label><br><br>

        <button id="btn-configure">Configure Device</button>
        <div id="status"></div>
    </div>

<script>
    const installButton = document.getElementById('install-button');
    const configSection = document.getElementById('config-section');
    const installStateSpan = document.getElementById('install-state');
    const sendConfigBtn = document.getElementById('btn-configure');
    const statusDiv = document.getElementById('config-status');

    // Hilfsfunktion: String zu Uint8Array
    function stringToUint8Array(str) {
        const arr = new Uint8Array(str.length);
        for (let i = 0; i < str.length; i++) {
            arr[i] = str.charCodeAt(i);
        }
        return arr;
    }

    // Generiere zufällige IDs beim Laden
    window.onload = () => {
        const tid = "dev_" + Math.random().toString(36).substring(2, 8);
        const pin = Math.floor(100000 + Math.random() * 900000);
        document.getElementById('tid').value = tid;
        document.getElementById('pin').value = pin;
    };

    // Überwache den Flash-Fortschritt nur, um das Menü einzublenden
    installButton.addEventListener('state-change', (ev) => {
        const state = ev.detail.state;
        console.log('Install State:', state);
        installStateSpan.innerText = state;

        // Wenn fertig (oder Fehler, damit man es debuggen kann), zeige Config an
        if (state === 'INSTALL_SUCCESSFUL' || state === 'IMPROV_SUCCESSFUL' || state.includes('SUCCESS') || state === 'ERROR') {
                configSection.classList.remove('hidden');
        }
    });

    // HAUPTLOGIK: Senden der Konfiguration via Web Serial
    // Basierend auf Recherche: Erzwingt NEUE Verbindung und setzt DTR/RTS für C3
    sendConfigBtn.addEventListener('click', async () => {
        statusDiv.innerText = "Starting connection sequence...";
        statusDiv.style.color = "blue";

        let port;
        let writer;

        try {
            // 1. ERZWINGE NEUE PORT-AUSWAHL
            // Der User MUSS das Gerät neu auswählen, um den Konflikt mit dem Flasher zu lösen.
            statusDiv.innerText = "WICHTIG: Wählen Sie den Port erneut aus...";
            port = await navigator.serial.requestPort();

            // 2. PORT ÖFFNEN (Mit C3-spezifischen Flags)
            statusDiv.innerText = "Opening port (setting DTR/RTS)...";
            // WICHTIG lt. Recherche: dataTerminalReady und requestToSend sind nötig für ESP32-C3 CDC
            await port.open({ baudRate: 115200, dataTerminalReady: true, requestToSend: true });

            // Kurze Pause zur Stabilisierung
            await new Promise(r => setTimeout(r, 100));

            // 3. DATENPAKET BAUEN
            const tid = document.getElementById('tid').value;
            const pin = document.getElementById('pin').value;
            const secret = document.getElementById('secret').value;
            const host = document.getElementById('host').value;
            const ssid = document.getElementById('ssid').value;
            const pass = document.getElementById('pass').value;

            if (!secret || !host || !ssid || !pass) {
                throw new Error("Please fill all fields (SSID, Pass, Secret, Host).");
            }

            // Format: TenantID|PIN|Secret|Host|SSID|Pass
            const dataStr = `${tid}|${pin}|${secret}|${host}|${ssid}|${pass}`;
            const dataBytes = stringToUint8Array(dataStr);
            const len = dataBytes.length;

            // Checksumme berechnen: (0x04 + Len + Sum(Data)) & 0xFF
            let sum = 0x04 + len;
            for(let b of dataBytes) sum += b;
            const checksum = sum & 0xFF;

            // Paket bauen: [0x04, Len, ...Data, Checksum]
            const packet = new Uint8Array(2 + len + 1);
            packet[0] = 0x04;
            packet[1] = len;
            packet.set(dataBytes, 2);
            packet[len + 2] = checksum;

            console.log("Sending Packet (Hex):", packet);

            // 4. SENDEN
            statusDiv.innerText = `Sending ${packet.length} bytes...`;
            writer = port.writable.getWriter();
            await writer.write(packet);

            // WICHTIG: Writer schließen, damit Daten physisch rausgespült werden
            writer.releaseLock();

            statusDiv.innerText = "Config SENT! Check device logs. Device should reboot.";
            statusDiv.style.color = "green";

        } catch (err) {
            console.error(err);
            // Zeige spezifische Fehler bei Port-Problemen
            if (err.name === 'NotFoundError') {
                statusDiv.innerText = "Error: No device selected.";
            } else if (err.name === 'NetworkError') {
                 statusDiv.innerText = "Error: Port busy. Unplug device and try again.";
            } else {
                statusDiv.innerText = "Error: " + err.message;
            }
            statusDiv.style.color = "red";
            if (writer) writer.releaseLock();
        } finally {
            // 5. PORT SAUBER SCHLIESSEN
            if (port && port.readable) {
                await port.close();
                console.log("Port closed safely.");
            }
        }
    });
</script>
</body>
</html>
